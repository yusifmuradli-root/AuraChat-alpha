<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuraChat - Basit Sohbet Uygulamasƒ±</title>
    
    <!-- Firebase SDK'larƒ± -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 1000px;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .chat-container {
            display: flex;
            height: 500px;
        }
        
        .users-panel {
            width: 250px;
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            padding: 15px;
            overflow-y: auto;
        }
        
        .users-panel h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .users-list {
            list-style: none;
        }
        
        .user-item {
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #495057;
        }
        
        .user-item.active {
            background: #e7f3ff;
            border-left: 4px solid #667eea;
        }
        
        .user-item .dot {
            width: 10px;
            height: 10px;
            background: #28a745;
            border-radius: 50%;
            display: inline-block;
        }
        
        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .messages-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px 15px;
            border-radius: 15px;
            max-width: 80%;
            position: relative;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.system {
            background: #e9ecef;
            color: #6c757d;
            margin-left: auto;
            margin-right: auto;
            max-width: 100%;
            text-align: center;
            font-style: italic;
            border-radius: 8px;
        }
        
        .message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .message.other {
            background: white;
            color: #495057;
            margin-right: auto;
            border: 1px solid #dee2e6;
            border-bottom-left-radius: 4px;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 12px;
            opacity: 0.9;
        }
        
        .message-username {
            font-weight: bold;
            font-size: 14px;
        }
        
        .message-time {
            font-size: 11px;
            opacity: 0.7;
        }
        
        .message-content {
            line-height: 1.5;
            word-wrap: break-word;
        }
        
        .input-area {
            padding: 15px;
            background: white;
            border-top: 1px solid #dee2e6;
            display: flex;
            gap: 10px;
        }
        
        .input-area input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .input-area input:focus {
            border-color: #667eea;
        }
        
        .input-area button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .input-area button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .input-area button:disabled {
            background: #adb5bd;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .login-container {
            padding: 40px;
            text-align: center;
        }
        
        .login-container h2 {
            color: #495057;
            margin-bottom: 30px;
        }
        
        .login-form {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .login-form input {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .login-form input:focus {
            border-color: #667eea;
        }
        
        .login-form button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .login-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .logout-btn {
            background: #dc3545;
            padding: 8px 15px;
            border-radius: 8px;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.3s;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        .hidden {
            display: none;
        }
        
        .typing-indicator {
            color: #6c757d;
            font-style: italic;
            font-size: 13px;
            margin-top: 5px;
            padding: 5px 10px;
            background: #f8f9fa;
            border-radius: 8px;
            display: inline-block;
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6c757d;
            text-align: center;
            padding: 20px;
        }
        
        .empty-state p {
            margin-top: 15px;
            font-size: 14px;
            opacity: 0.7;
        }
        
        .error-banner {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            text-align: center;
            border-bottom: 2px solid #f5c6cb;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Giri≈ü Ekranƒ± -->
        <div id="loginScreen" class="login-container">
            <h2>‚ú® AuraChat</h2>
            <p>Basit ve hƒ±zlƒ± sohbet platformu</p>
            <div class="login-form">
                <input type="text" id="usernameInput" placeholder="Kullanƒ±cƒ± adƒ±nƒ±zƒ± girin (3-15 karakter)" maxlength="15" autofocus>
                <button onclick="login()">Sohbete Ba≈üla</button>
                <p style="margin-top: 15px; font-size: 12px; color: #6c757d;">
                    Not: Kullanƒ±cƒ± adƒ± sadece harf ve rakam i√ßerebilir
                </p>
            </div>
        </div>
        
        <!-- Sohbet Ekranƒ± -->
        <div id="chatScreen" class="hidden">
            <div class="header">
                <h1>üí¨ AuraChat</h1>
                <p id="currentUserDisplay">Ho≈ü geldiniz!</p>
                <button class="logout-btn" onclick="logout()">√áƒ±kƒ±≈ü Yap</button>
            </div>
            
            <div class="chat-container">
                <div class="users-panel">
                    <h3>üë• Aktif Kullanƒ±cƒ±lar (<span id="activeCount">0</span>)</h3>
                    <ul id="usersList" class="users-list">
                        <div class="empty-state">
                            <p>Hen√ºz aktif kullanƒ±cƒ± yok</p>
                        </div>
                    </ul>
                </div>
                
                <div class="chat-panel">
                    <div id="messagesArea" class="messages-area">
                        <div class="empty-state">
                            <h3>Ho≈ü geldiniz! üéâ</h3>
                            <p>ƒ∞lk mesajƒ± siz g√∂nderin!</p>
                        </div>
                    </div>
                    
                    <div class="input-area">
                        <input type="text" id="messageInput" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..." onkeypress="handleKeyPress(event)">
                        <button onclick="sendMessage()" id="sendButton">G√∂nder</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // XSS Korumasƒ± i√ßin yardƒ±mcƒ± fonksiyon
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }
        
        // Firebase yapƒ±landƒ±rmasƒ± - AURAchat-alpha
        const firebaseConfig = {
            apiKey: "AIzaSyDOjBIYEmA7B7QcBanSL51bpGHPm0ctBQs",
            authDomain: "aurachat-alpha.firebaseapp.com",
            projectId: "aurachat-alpha",
            storageBucket: "aurachat-alpha.firebasestorage.app",
            messagingSenderId: "966676623990",
            appId: "1:966676623990:web:1b55771f9353b5fdb72557"
        };
        
        // Firebase ba≈ülatma
        let db, auth;
        try {
            // Firebase'i ba≈ülat
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            
            console.log("‚úÖ Firebase ba≈üarƒ±yla ba≈ülatƒ±ldƒ±!");
        } catch (error) {
            console.error("‚ùå Firebase ba≈ülatma hatasƒ±:", error);
            alert("Firebase ba≈ülatƒ±lamadƒ±! L√ºtfen internet baƒülantƒ±nƒ±zƒ± kontrol edin.");
        }
        
        // Global deƒüi≈ükenler
        let currentUser = null;
        let messagesRef = null;
        let usersRef = null;
        let unsubscribeMessages = null;
        let unsubscribeUsers = null;
        
        // Giri≈ü fonksiyonu
        async function login() {
            const usernameInput = document.getElementById('usernameInput').value.trim();
            
            // Kullanƒ±cƒ± adƒ± doƒürulama
            if (!usernameInput) {
                alert("L√ºtfen kullanƒ±cƒ± adƒ± girin!");
                return;
            }
            
            if (usernameInput.length < 3 || usernameInput.length > 15) {
                alert("Kullanƒ±cƒ± adƒ± 3-15 karakter arasƒ±nda olmalƒ±dƒ±r!");
                return;
            }
            
            if (!/^[a-zA-Z0-9ƒü√º≈ü√∂√ßƒ±ƒû√ú≈û√ñ√áƒ∞]+$/.test(usernameInput)) {
                alert("Kullanƒ±cƒ± adƒ± sadece harf ve rakam i√ßerebilir!");
                return;
            }
            
            try {
                // Anonymous auth ile giri≈ü
                const userCredential = await auth.signInAnonymously();
                
                // Kullanƒ±cƒ± bilgilerini kaydet
                currentUser = {
                    id: userCredential.user.uid,
                    username: usernameInput,
                    joinedAt: new Date()
                };
                
                // Firestore'a kullanƒ±cƒ±yƒ± ekle
                await db.collection('users').doc(currentUser.id).set({
                    username: currentUser.username,
                    lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                    online: true
                });
                
                // Firestore referanslarƒ±
                messagesRef = db.collection('messages');
                usersRef = db.collection('users');
                
                // Ho≈ü geldin mesajƒ± g√∂nder
                await messagesRef.add({
                    username: currentUser.username,
                    message: `üëã ${currentUser.username} sohbete katƒ±ldƒ±!`,
                    type: 'system',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Mesajlarƒ± dinle
                setupMessageListener();
                
                // Kullanƒ±cƒ±larƒ± dinle
                setupUsersListener();
                
                // Ekranƒ± deƒüi≈ütir
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('chatScreen').classList.remove('hidden');
                document.getElementById('currentUserDisplay').textContent = `@${currentUser.username}`;
                
                // Mesaj inputuna odaklan
                document.getElementById('messageInput').focus();
                
                console.log("‚úÖ Giri≈ü ba≈üarƒ±lƒ±:", currentUser);
                
            } catch (error) {
                console.error("‚ùå Giri≈ü hatasƒ±:", error);
                alert("Giri≈ü yapƒ±lƒ±rken bir hata olu≈ütu: " + error.message);
            }
        }
        
        // Mesaj g√∂nderme
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !currentUser) return;
            
            // Mesaj uzunluk kontrol√º
            if (message.length > 500) {
                alert("Mesaj √ßok uzun! Maksimum 500 karakter.");
                return;
            }
            
            try {
                // Firestore'a mesaj ekle
                await messagesRef.add({
                    username: currentUser.username,
                    message: message,
                    userId: currentUser.id,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Input'u temizle
                messageInput.value = '';
                
                // Scroll'u en alta al
                scrollToBottom();
                
            } catch (error) {
                console.error("‚ùå Mesaj g√∂nderme hatasƒ±:", error);
                alert("Mesaj g√∂nderilirken bir hata olu≈ütu!");
            }
        }
        
        // Enter tu≈üu ile g√∂nderme
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        // Mesajlarƒ± dinleme
        function setupMessageListener() {
            if (!messagesRef) return;
            
            // Son 50 mesajƒ± getir ve yeni mesajlarƒ± dinle
            unsubscribeMessages = messagesRef
                .orderBy('timestamp', 'desc')
                .limit(50)
                .onSnapshot((snapshot) => {
                    const messagesArea = document.getElementById('messagesArea');
                    const messages = [];
                    
                    snapshot.forEach((doc) => {
                        messages.push(doc.data());
                    });
                    
                    // Mesajlarƒ± tarihe g√∂re sƒ±rala (eski -> yeni)
                    messages.reverse();
                    
                    // Mesajlarƒ± g√∂ster
                    displayMessages(messages);
                }, (error) => {
                    console.error("Mesaj dinleme hatasƒ±:", error);
                    alert("Mesajlar y√ºklenirken hata olu≈ütu!");
                });
        }
        
        // Mesajlarƒ± g√∂sterme
        function displayMessages(messages) {
            const messagesArea = document.getElementById('messagesArea');
            
            if (messages.length === 0) {
                messagesArea.innerHTML = `
                    <div class="empty-state">
                        <h3>Ho≈ü geldiniz! üéâ</h3>
                        <p>ƒ∞lk mesajƒ± siz g√∂nderin!</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            messages.forEach((msg) => {
                const time = msg.timestamp ? formatTimestamp(msg.timestamp) : '';
                const isCurrentUser = msg.userId === currentUser?.id;
                
                if (msg.type === 'system') {
                    // Sistem mesajƒ±
                    html += `
                        <div class="message system">
                            <div class="message-content">${escapeHtml(msg.message)}</div>
                        </div>
                    `;
                } else {
                    // Normal mesaj
                    const messageType = isCurrentUser ? 'user' : 'other';
                    html += `
                        <div class="message ${messageType}">
                            <div class="message-header">
                                <span class="message-username">${escapeHtml(msg.username)}</span>
                                <span class="message-time">${time}</span>
                            </div>
                            <div class="message-content">${escapeHtml(msg.message)}</div>
                        </div>
                    `;
                }
            });
            
            messagesArea.innerHTML = html;
            scrollToBottom();
        }
        
        // Kullanƒ±cƒ±larƒ± dinleme
        function setupUsersListener() {
            if (!usersRef) return;
            
            unsubscribeUsers = usersRef
                .where('online', '==', true)
                .onSnapshot((snapshot) => {
                    const users = [];
                    
                    snapshot.forEach((doc) => {
                        users.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    displayUsers(users);
                }, (error) => {
                    console.error("Kullanƒ±cƒ± dinleme hatasƒ±:", error);
                });
        }
        
        // Kullanƒ±cƒ±larƒ± g√∂sterme
        function displayUsers(users) {
            const usersList = document.getElementById('usersList');
            const activeCount = document.getElementById('activeCount');
            
            activeCount.textContent = users.length;
            
            if (users.length === 0) {
                usersList.innerHTML = `
                    <div class="empty-state">
                        <p>Hen√ºz aktif kullanƒ±cƒ± yok</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            users.forEach((user) => {
                const isActive = user.id === currentUser?.id ? 'active' : '';
                html += `
                    <li class="user-item ${isActive}">
                        <span class="dot"></span>
                        <span>${escapeHtml(user.username)}</span>
                    </li>
                `;
            });
            
            usersList.innerHTML = html;
        }
        
        // Zaman formatlama
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diffHours = (now - date) / (1000 * 60 * 60);
            
            // Bug√ºn ise sadece saat
            if (diffHours < 24) {
                return date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
            }
            
            // Farklƒ± g√ºn ise tarih + saat
            return date.toLocaleDateString('tr-TR', { 
                day: '2-digit', 
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Scroll en alta
        function scrollToBottom() {
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }
        
        // √áƒ±kƒ±≈ü yapma
        async function logout() {
            if (!currentUser) return;
            
            try {
                // Ayrƒ±lma mesajƒ± g√∂nder
                await messagesRef.add({
                    username: currentUser.username,
                    message: `üëã ${currentUser.username} sohbetten ayrƒ±ldƒ±.`,
                    type: 'system',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Kullanƒ±cƒ±yƒ± offline yap
                await db.collection('users').doc(currentUser.id).update({
                    online: false,
                    lastActive: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Dinleyicileri durdur
                if (unsubscribeMessages) unsubscribeMessages();
                if (unsubscribeUsers) unsubscribeUsers();
                
                // Firebase auth √ßƒ±kƒ±≈ü
                await auth.signOut();
                
                // Ekranƒ± deƒüi≈ütir
                document.getElementById('chatScreen').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('usernameInput').value = '';
                
                currentUser = null;
                messagesRef = null;
                usersRef = null;
                
                console.log("‚úÖ √áƒ±kƒ±≈ü yapƒ±ldƒ±");
                
            } catch (error) {
                console.error("‚ùå √áƒ±kƒ±≈ü hatasƒ±:", error);
            }
        }
        
        // Sayfa kapatƒ±ldƒ±ƒüƒ±nda temizlik
        window.addEventListener('beforeunload', async () => {
            if (currentUser && usersRef) {
                try {
                    await db.collection('users').doc(currentUser.id).update({
                        online: false,
                        lastActive: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error("√áƒ±kƒ±≈ü g√ºncelleme hatasƒ±:", error);
                }
            }
        });
        
        // Otomatik scroll i√ßin observer
        setTimeout(() => {
            const messagesArea = document.getElementById('messagesArea');
            if (messagesArea) {
                const observer = new MutationObserver(() => {
                    scrollToBottom();
                });
                
                observer.observe(messagesArea, {
                    childList: true,
                    subtree: true
                });
            }
        }, 100);
    </script>
</body>
</html>
